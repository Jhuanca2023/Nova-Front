<div class="mt-12 bg-base-100 rounded-2xl shadow-lg border border-base-200 overflow-hidden">
  <div class="bg-gradient-to-r from-primary/10 to-base-100 p-6 border-b">
    <div class="flex items-center space-x-2">
      <lucide-angular name="message-circle" class="w-6 h-6 text-primary"></lucide-angular>
      <h2 class="text-2xl font-semibold">Opiniones de clientes</h2>
    </div>
  </div>

  <div class="p-6">
    <div class="p-4 mb-8 bg-base-200/50 rounded-xl">
      <div class="flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-4">
          <div class="stats bg-base-100 shadow-sm flex-shrink-0">
            <div class="stat p-3 md:p-4">
              <div class="stat-value text-primary text-center">
                {{ rating() }}
              </div>
              <div class="stat-title text-center text-sm opacity-70">
                Valoración
              </div>
              <rating-display [rating]="rating()" [totalReviews]="0"></rating-display>
            </div>
          </div>

          <div class="hidden md:block h-12 w-px bg-base-300 mx-2"></div>

          <div class="flex flex-col">
            <div class="text-lg font-medium">
              {{ totalCommentsCount() }} opiniones
            </div>
            <div class="text-sm opacity-70">de clientes verificados</div>
          </div>
        </div>

        <div class="badge badge-lg badge-outline badge-primary self-end">
          Página {{ getCommentsPageNumber() }} de {{ getCommentsTotalPages() }}
        </div>
      </div>
    </div>

    <!-- Formulario para añadir o editar un comentario -->
    @if (isWritingReview()) {
      <div class="card bg-base-200/50 p-6 mb-8">
        <h3 class="text-xl font-semibold mb-4">
          @if (isEditingMode()) {
            Editar tu opinión
          } @else {
            Escribe tu opinión
          }
        </h3>

        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Tu calificación</span>
          </label>
          <div class="flex space-x-1">
            @for (star of [1, 2, 3, 4, 5]; track star) {
              <button
                type="button"
                class="btn btn-ghost p-1"
                (click)="setRating(star)"
                [class.text-yellow-400]="star <= newRating()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  [attr.fill]="star <= newRating() ? '#FBBF24' : 'none'"
                  stroke="currentColor"
                  [ngClass]="star <= newRating() ? 'text-yellow-400' : 'text-gray-300'"
                  class="w-8 h-8 transition-all"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
                  />
                </svg>
              </button>
            }
          </div>
        </div>

        <div class="form-control mb-4 flex flex-col">
          <label class="label">
            <span class="label-text">Tu comentario</span>
          </label>
          <textarea
            class="textarea textarea-bordered h-24 w-full"
            placeholder="Comparte tu experiencia con este producto..."
            [(ngModel)]="newComment"
          ></textarea>
        </div>

        <div class="flex justify-end gap-2">
          <button
            type="button"
            class="btn btn-outline btn-sm"
            (click)="cancelReview()"
            [disabled]="isSubmitting()"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn btn-primary btn-sm"
            (click)="submitComment()"
            [disabled]="!newComment() || newRating() === 0 || isSubmitting()"
            [class.loading]="isSubmitting()"
          >
            <lucide-angular name="send" class="w-4 h-4 mr-1"></lucide-angular>
            @if (isEditingMode()) {
              Actualizar reseña
            } @else {
              Publicar reseña
            }
          </button>
        </div>
      </div>
    }

    @defer {
      @if (comments().length === 0) {
        <div class="card bg-base-200/50 p-12 text-center">
          <lucide-angular name="message-square-off"
                          class="w-12 h-12 mx-auto mb-4 text-base-content/30"></lucide-angular>
          <p class="text-xl text-base-content/70">
            Este producto aún no tiene reseñas.
          </p>
          <p class="mt-2 text-base-content/50">
            ¡Sé el primero en compartir tu experiencia!
          </p>
        </div>
      } @else {
        <div class="space-y-6">
          @for (comment of comments(); track comment.id) {
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 border border-base-200">
              <div class="card-body">
                <div class="flex items-start">
                  <div class="avatar mr-4">
                    <div [ngClass]="getRingClass(comment.rating)"
                         class="w-12 h-12 rounded-full">
                      <!-- Usar imagen de perfil si existe, de lo contrario mostrar iniciales -->
                      @if (hasAvatar(comment)) {
                        <img
                          [src]="getUserAvatar(comment)"
                          [alt]="comment.userName"
                          class="w-full h-full object-cover"
                          (error)="onAvatarError(comment.userId)"
                        />
                      } @else {
                        <div
                          class="w-12 h-12 rounded-full flex items-center justify-center"
                          [ngClass]="getAvatarBackgroundColor(comment.userId)"
                        >
                          <span class="text-lg font-bold">{{ getFirstLetterUppercase(comment.userName) }}</span>
                        </div>
                      }
                    </div>
                  </div>

                  <div class="flex-1">
                    <div class="flex items-center justify-between flex-wrap gap-2">
                      <h3 class="font-bold text-lg">
                        {{ comment.userName }}
                        @if (comment.userId === currentUserId()) {
                          <span class="badge badge-ghost">Tú</span>
                        }
                      </h3>
                      <div class="flex items-center gap-2">
                        <div class="badge badge-outline">
                          {{ comment.date | date : "mediumDate" }}
                        </div>
                        <!-- Botones de editar y eliminar, solo visibles para el dueño del comentario -->
                        @if (isCommentOwner(comment) && !isSubmitting() && !isDeleting()) {
                          <div class="dropdown dropdown-end">
                            <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                              <lucide-angular name="more-vertical" class="w-4 h-4"></lucide-angular>
                            </div>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                              <li>
                                <a (click)="editComment(comment)">
                                  <lucide-angular name="edit-3" class="w-4 h-4 mr-1"></lucide-angular>
                                  Editar comentario
                                </a>
                              </li>
                              <li>
                                <a class="text-error" (click)="showDeleteConfirmation(comment)">
                                  <lucide-angular name="trash-2" class="w-4 h-4 mr-1"></lucide-angular>
                                  Eliminar comentario
                                </a>
                              </li>
                            </ul>
                          </div>
                        }
                      </div>
                    </div>

                    <div class="tooltip tooltip-bottom mt-2"
                         [attr.data-tip]="'Calificación: ' + comment.rating + ' de 5'">
                      <div class="flex space-x-1">
                        @for (star of [1, 2, 3, 4, 5]; track star) {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                               [attr.fill]="star <= comment.rating ? '#FBBF24' : 'none'"
                               stroke="currentColor"
                               [ngClass]="star <= comment.rating ? 'text-yellow-400' : 'text-gray-300'"
                               class="w-6 h-6 transition-all">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                          </svg>
                        }
                      </div>
                    </div>

                    <div class="mt-3 text-base-content/90 border-l-4 border-primary/20 pl-4 py-1 italic">
                      "{{ comment.comment }}"
                    </div>
                  </div>
                </div>

                @if (comment.rating >= 4) {
                  <div class="card-actions justify-end mt-2">
                    <div class="badge badge-sm badge-primary gap-1">
                      <lucide-angular name="check-circle" class="w-3 h-3"></lucide-angular>
                      Compra verificada
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      @if (getCommentsTotalPages() > 1) {
        <div class="flex justify-center mt-8">
          <div class="join shadow-sm">
            <button
              class="join-item btn"
              [disabled]="getCommentsPageNumber() === 1"
              (click)="loadCommentPage(getCommentsPageNumber() - 1)"
            >
              <lucide-angular name="chevron-left" class="w-5 h-5"></lucide-angular>
            </button>

            @for (page of getPageNumbers(); track page) {
              <button
                class="join-item btn"
                [class.btn-primary]="page === getCommentsPageNumber()"
                (click)="loadCommentPage(page)"
              >
                {{ page }}
              </button>
            }

            <button
              class="join-item btn"
              [disabled]="getCommentsPageNumber() === getCommentsTotalPages()"
              (click)="loadCommentPage(getCommentsPageNumber() + 1)"
            >
              <lucide-angular name="chevron-right" class="w-5 h-5"></lucide-angular>
            </button>
          </div>
        </div>
      }
    } @loading {
      <div class="flex justify-center p-12">
        <span class="loading loading-spinner loading-md text-primary"></span>
      </div>
    }

    <div class="flex justify-between items-center mt-8">
      @if (!isWritingReview()) {
        <button
          class="btn btn-sm btn-primary"
          (click)="startReview()"
          [disabled]="hasUserAlreadyCommented()"
          [attr.title]="hasUserAlreadyCommented() ? 'Ya has comentado este producto' : ''"
        >
          <lucide-angular name="message-square-plus" class="w-4 h-4 mr-1"></lucide-angular>
          Escribir una reseña
        </button>
      } @else {
        <div></div>
      }
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar comentario -->
@if (showDeleteModal()) {
  <div class="modal modal-open fixed inset-0 bg-black/50 z-40 flex items-center justify-center">
    <div class="modal-box max-w-md relative">
      <!-- Botón cerrar en esquina superior derecha -->
      <button
        class="btn btn-sm btn-circle absolute right-2 top-2"
        (click)="cancelDelete()">
        <lucide-angular name="x" class="w-4 h-4"></lucide-angular>
      </button>

      <h3 class="font-bold text-lg mb-4 flex items-center">
        <lucide-angular name="alert-triangle" class="w-6 h-6 mr-2 text-error"></lucide-angular>
        Confirmar eliminación
      </h3>

      <p class="py-4">¿Estás seguro de que deseas eliminar este comentario? Esta acción no se puede deshacer.</p>

      <div class="modal-action">
        <button
          class="btn btn-outline"
          (click)="cancelDelete()"
          [disabled]="isDeleting()">
          Cancelar
        </button>
        <button
          class="btn btn-error"
          (click)="confirmDelete()"
          [disabled]="isDeleting()">
          @if (isDeleting()) {
            <span class="loading loading-spinner loading-xs mr-2"></span>
            Eliminando...
          } @else {
            <lucide-angular name="trash-2" class="w-4 h-4 mr-1"></lucide-angular>
            Eliminar
          }
        </button>
      </div>
    </div>

    <!-- Capa adicional para cerrar el modal haciendo clic fuera -->
    <div class="modal-backdrop" (click)="cancelDelete()"></div>
  </div>
}
