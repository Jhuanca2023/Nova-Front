<div class="container mx-auto p-6">
  <!-- Header -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"
  >
    <div>
      <h1 class="text-2xl font-bold">Usuarios</h1>
      <p class="text-muted-foreground">Administra los usuarios del sistema</p>
    </div>
    <div class="flex gap-2 mt-4 md:mt-0">
      <button
        class="btn btn-outline"
        (click)="downloadUserReport()"
        [disabled]="isGeneratingReport()"
      >
        @if (isGeneratingReport()) {
        <span class="loading loading-spinner loading-xs"></span>
        } @else {
        <lucide-angular name="file-text" class="w-5 h-5 mr-2"></lucide-angular>
        } Descargar Reporte
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card bg-base-100 shadow mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <lucide-angular name="filter" class="w-5 h-5 mr-2"></lucide-angular>
        Filtros
      </h2>

      <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
        <!-- Estado -->
        <div class="flex flex-wrap gap-2">
          <button
            class="btn btn-sm"
            [class.btn-primary]="filterStatus() === 'all'"
            [class.btn-outline]="filterStatus() !== 'all'"
            (click)="setStatusFilter('all')"
          >
            Todos ({{ userCount().total }})
          </button>
          <button
            class="btn btn-sm"
            [class.btn-success]="filterStatus() === 'active'"
            [class.btn-outline]="filterStatus() !== 'active'"
            (click)="setStatusFilter('active')"
          >
            <lucide-angular
              name="check-circle"
              class="w-4 h-4 mr-1"
            ></lucide-angular>
            Activos ({{ userCount().active }})
          </button>
          <button
            class="btn btn-sm"
            [class.btn-error]="filterStatus() === 'inactive'"
            [class.btn-outline]="filterStatus() !== 'inactive'"
            (click)="setStatusFilter('inactive')"
          >
            <lucide-angular
              name="x-circle"
              class="w-4 h-4 mr-1"
            ></lucide-angular>
            Inactivos ({{ userCount().inactive }})
          </button>
        </div>

        <!-- Buscador -->
        <div class="form-control flex-1">
          <div class="input-group">
            <input
              type="text"
              placeholder="Buscar por nombre, email..."
              class="input input-bordered w-full"
              [formControl]="searchControl"
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="flex justify-center items-center py-20">
    <div class="flex flex-col items-center">
      <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
      <span class="text-base-content/70">Cargando usuarios...</span>
    </div>
  </div>
  } @else if (filteredUsers().length === 0) {
  <!-- Empty State -->
  <div class="card bg-base-100 shadow">
    <div class="card-body items-center text-center py-16">
      <lucide-angular
        name="users"
        class="w-16 h-16 text-base-300 mb-4"
      ></lucide-angular>
      <h2 class="card-title">No se encontraron usuarios</h2>
      <p class="text-base-content/70 mb-8">
        @if (searchControl.value) { No hay usuarios que coincidan con tu
        búsqueda. Prueba con otros términos. } @else { No hay usuarios
        registrados en el sistema. }
      </p>
      <div class="flex gap-4">
        <button class="btn btn-outline" (click)="reloadUsers()">
          <lucide-angular
            name="refresh-cw"
            class="w-5 h-5 mr-2"
          ></lucide-angular>
          Recargar
        </button>
        <a routerLink="create" class="btn btn-primary">
          <lucide-angular
            name="user-plus"
            class="w-5 h-5 mr-2"
          ></lucide-angular>
          Crear nuevo usuario
        </a>
      </div>
    </div>
  </div>
  } @else {
  <!-- Users Table -->
  <div class="card bg-base-100 shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <!-- Table Head -->
        <thead>
          <tr>
            <th>Usuario</th>
            <th class="cursor-pointer" (click)="sortBy('email')">
              <div class="flex items-center">
                Email @if (sortColumn() === 'email') {
                <lucide-angular
                  [name]="
                    sortDirection() === 'asc' ? 'chevron-up' : 'chevron-down'
                  "
                  class="w-4 h-4 ml-1"
                ></lucide-angular>
                }
              </div>
            </th>
            <th class="cursor-pointer" (click)="sortBy('lastLogin')">
              <div class="flex items-center">
                Último acceso @if (sortColumn() === 'lastLogin') {
                <lucide-angular
                  [name]="
                    sortDirection() === 'asc' ? 'chevron-up' : 'chevron-down'
                  "
                  class="w-4 h-4 ml-1"
                ></lucide-angular>
                }
              </div>
            </th>
            <th>Rol</th>
            <th>Estado</th>
            <th class="text-right">Acciones</th>
          </tr>
        </thead>
        <!-- Table Body -->
        <tbody>
          @for (user of filteredUsers(); track user.id) {
          <tr class="user-row">
            <td>
              <div class="flex items-center space-x-3">
                <div class="avatar placeholder">
                  @if (hasAvatar(user)) {
                  <div class="w-10 h-10 rounded-full">
                    <img
                      [src]="getUserAvatar(user)"
                      alt="Avatar de usuario"
                      (error)="onAvatarError(user.id)"
                      class="w-full h-full object-cover"
                    />
                  </div>
                  } @else {
                  <div
                    class="w-10 h-10 rounded-full flex items-center justify-center"
                    [ngClass]="getAvatarBackgroundColor(user.id)"
                    style="position: relative"
                  >
                    <span
                      class="text-lg font-bold"
                      style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        line-height: 1;
                      "
                      >{{
                        user.initialAvatar ||
                          getUserInitials(user.firstName, user.lastName)
                      }}</span
                    >
                  </div>
                  }
                </div>

                <div>
                  <div class="font-bold">
                    {{ user.firstName }} {{ user.lastName }}
                  </div>
                  <div class="text-sm opacity-50">
                    Creado: {{ formatDate(user.createdAt) }}
                  </div>
                </div>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>{{ user.lastLogin ? formatDate(user.lastLogin) : "Nunca" }}</td>
            <td>
              <div class="badge {{ getRoleBadgeClass(user.role) }}">
                {{ user.role === "admin" ? "Administrador" : "Usuario" }}
              </div>
            </td>
            <td>
              <button
                class="badge status-badge min-w-[100px] py-3 status-toggle"
                [class]="user.active ? 'badge-success' : 'badge-error'"
                [disabled]="isTogglingStatus() === user.id"
                (click)="toggleUserStatus(user)"
              >
                @if (isTogglingStatus() === user.id) {
                <span class="loading loading-spinner loading-xs mr-1"></span>
                Cambiando... } @else if (user.active) {
                <lucide-angular
                  name="check"
                  class="w-4 h-4 mr-1"
                ></lucide-angular>
                Activo } @else {
                <lucide-angular name="x" class="w-4 h-4 mr-1"></lucide-angular>
                Inactivo }
              </button>
            </td>
            <td class="text-right">
              <div class="btn-group">
                <a
                  [routerLink]="['edit', user.id]"
                  class="btn btn-sm btn-ghost tooltip"
                  data-tip="Editar"
                >
                  <lucide-angular name="edit" class="w-4 h-4"></lucide-angular>
                </a>
                <!-- <button
                  class="btn btn-sm btn-ghost tooltip"
                  data-tip="Cambiar rol"
                  (click)="toggleUserStatus(user)"
                >
                  <lucide-angular
                    name="shield"
                    class="w-4 h-4"
                  ></lucide-angular>
                </button> -->
                <button
                  class="btn btn-sm btn-ghost tooltip text-error"
                  data-tip="Eliminar"
                  (click)="openDeleteModal(user)"
                >
                  <lucide-angular
                    name="trash-2"
                    class="w-4 h-4"
                  ></lucide-angular>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div
      class="flex items-center justify-between border-t border-base-300 bg-base-100 px-4 py-3"
    >
      <div class="flex flex-1 justify-between sm:hidden">
        <button class="btn btn-sm btn-ghost">Anterior</button>
        <button class="btn btn-sm btn-ghost">Siguiente</button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-base-content/70">
            Mostrando
            <span class="font-medium">1</span>
            a
            <span class="font-medium">{{ filteredUsers().length }}</span>
            de
            <span class="font-medium">{{ filteredUsers().length }}</span>
            resultados
          </p>
        </div>
        <div class="join">
          <button class="join-item btn btn-sm" disabled>«</button>
          <button class="join-item btn btn-sm btn-active">1</button>
          <button class="join-item btn btn-sm" disabled>»</button>
        </div>
      </div>
    </div>
  </div>
  } @if (showDeleteModal()) {
  <div class="modal modal-open" role="dialog">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Confirmar eliminación</h3>

      <p class="py-4">
        ¿Estás seguro de que deseas eliminar al usuario
        <span class="font-bold"
          >{{ userToDelete()?.firstName }} {{ userToDelete()?.lastName }}</span
        >?
        <br />
        <span class="text-error">Esta acción no se puede deshacer.</span>
      </p>

      @if (deleteError()) {
      <div class="alert alert-error mb-4">
        <lucide-angular name="alert-circle" class="w-5 h-5"></lucide-angular>
        <span>{{ deleteError() }}</span>
      </div>
      }

      <div class="modal-action">
        <button
          class="btn"
          [disabled]="isDeleting()"
          (click)="closeDeleteModal()"
        >
          Cancelar
        </button>
        <button
          class="btn btn-error"
          [disabled]="isDeleting()"
          (click)="confirmDelete()"
        >
          @if (isDeleting()) {
          <span class="loading loading-spinner loading-xs mr-2"></span>
          } @else {
          <lucide-angular name="trash-2" class="w-5 h-5 mr-2"></lucide-angular>
          } Eliminar
        </button>
      </div>
    </div>
    <div class="modal-backdrop" (click)="closeDeleteModal()"></div>
  </div>
  }
</div>
