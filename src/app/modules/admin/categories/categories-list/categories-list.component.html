<div class="container mx-auto p-6">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"
  >
    <div>
      <h1 class="text-2xl font-bold">Categorías</h1>
      <p class="text-muted-foreground">
        Administra las categorías de productos
      </p>
    </div>
    <button (click)="openAddModal()" class="btn btn-primary mt-4 md:mt-0">
      <lucide-angular name="plus" class="w-5 h-5 mr-2"></lucide-angular>
      Añadir categoría
    </button>
  </div>

  <!-- Main Card -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <!-- Header with Search -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"
      >
        <h2 class="card-title">Todas las categorías</h2>
        <div class="form-control w-full sm:w-64 mt-4 sm:mt-0">
          <div class="input-group flex">
            <button class="btn btn-square">
              <lucide-angular name="search" class="w-5 h-5"></lucide-angular>
            </button>
            <input
              type="text"
              placeholder="Buscar categorías..."
              class="input input-bordered w-full"
              [formControl]="searchControl"
            />
          </div>
        </div>
      </div>

      <!-- Loading state -->
      @if (categoryResource.isLoading()) {
        <div class="flex justify-center py-8">
          <span class="loading loading-spinner loading-lg"></span>
        </div>
      }

      <!-- Error state -->
      @if (categoryResource.error()) {
        <div class="alert alert-error">
          <lucide-angular name="alert-circle" class="w-5 h-5"></lucide-angular>
          <span>Error al cargar las categorías. Por favor, intenta nuevamente.</span>
          <button class="btn btn-sm" (click)="categoryResource.reload()">Reintentar</button>
        </div>
      }

      <!-- Data loaded state -->
      @if (!categoryResource.isLoading() && !categoryResource.error()) {
        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <!-- Table Head -->
            <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripción</th>
              <th class="text-right">Productos</th>
              <th>Fecha de creación</th>
              <th class="text-right">Acciones</th>
            </tr>
            </thead>
            <!-- Table Body -->
            <tbody>
              @for (category of filteredCategories(); track category.id) {
                <tr>
                  <td>{{ category.id }}</td>
                  <td>{{ category.name }}</td>
                  <td>{{ category.description }}</td>
                  <td class="text-right">{{ category.productCount }}</td>
                  <td>{{ formatDate(category.createdAt) }}</td>
                  <td>
                    <div class="flex justify-end space-x-2">
                      <button
                        class="btn btn-square btn-sm btn-ghost"
                        (click)="openEditModal(category)"
                      >
                        <lucide-angular
                          name="edit"
                          class="w-4 h-4"
                        ></lucide-angular>
                      </button>
                      <button
                        class="btn btn-square btn-sm btn-ghost text-error"
                        (click)="openDeleteModal(category)"
                      >
                        <lucide-angular
                          name="trash-2"
                          class="w-4 h-4"
                        ></lucide-angular>
                      </button>
                    </div>
                  </td>
                </tr>
              }

            <!-- No results message -->
              @if (filteredCategories().length === 0) {
                <tr>
                  <td colspan="6" class="text-center py-8">
                    No se encontraron categorías
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
          <div class="text-sm text-muted-foreground">
            {{ getPaginationInfo() }}
          </div>
          <div class="join">
            <button
              class="join-item btn"
              [disabled]="currentPage() === 1"
              (click)="goToPreviousPage()"
            >
              <lucide-angular
                name="chevron-left"
                class="w-5 h-5"
              ></lucide-angular>
            </button>
            <button class="join-item btn btn-active">
              {{ currentPage() }}
            </button>
            <button
              class="join-item btn"
              [disabled]="currentPage() === totalPages()"
              (click)="goToNextPage()"
            >
              <lucide-angular
                name="chevron-right"
                class="w-5 h-5"
              ></lucide-angular>
            </button>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Add Category Modal -->
  @if (showAddModal()) {
    <div class="modal modal-open">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Añadir categoría</h3>
        <p class="py-2 text-muted-foreground">
          Crea una nueva categoría para tus productos
        </p>

        @if (errorMessage()) {
          <div class="alert alert-error my-2">
            <lucide-angular name="alert-circle" class="w-5 h-5 mr-2"></lucide-angular>
            <span>{{ errorMessage() }}</span>
          </div>
        }

        <div class="form-control mt-4">
          <label class="label">
            <span class="label-text">Nombre</span>
          </label>
          <input
            type="text"
            placeholder="Nombre de la categoría"
            class="input input-bordered w-full"
            [formControl]="nameControl"
            [class.input-error]="nameControl.invalid && nameControl.touched"
          />
          @if (nameControl.invalid && nameControl.touched) {
            <label class="label">
              <span class="label-text-alt text-error">El nombre es obligatorio</span>
            </label>
          }
        </div>

        <div class="form-control mt-4 flex flex-col">
          <label class="label">
            <span class="label-text">Descripción</span>
          </label>
          <textarea
            class="textarea textarea-bordered min-h-[60px] w-full"
            placeholder="Descripción de la categoría..."
            [formControl]="descriptionControl"
            [class.textarea-error]="descriptionControl.invalid && descriptionControl.touched"
          ></textarea>
          @if (descriptionControl.invalid && descriptionControl.touched) {
            <label class="label">
              <span class="label-text-alt text-error">La descripción es obligatoria</span>
            </label>
          }
        </div>

        <div class="modal-action">
          <button class="btn" (click)="closeModals()" [disabled]="isSubmitting()">Cancelar</button>
          <button class="btn btn-primary" (click)="addCategory()" [disabled]="isSubmitting()">
            @if (isSubmitting()) {
              <span class="loading loading-spinner loading-xs mr-2"></span>
            }
            Guardar categoría
          </button>
        </div>
      </div>
      <div class="modal-backdrop" (click)="closeModals()"></div>
    </div>
  }

  <!-- Edit Category Modal -->
  @if (showEditModal()) {
    <div class="modal modal-open">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Editar categoría</h3>
        <p class="py-2 text-muted-foreground">
          Modifica los detalles de la categoría
        </p>

        @if (errorMessage()) {
          <div class="alert alert-error my-2">
            <lucide-angular name="alert-circle" class="w-5 h-5 mr-2"></lucide-angular>
            <span>{{ errorMessage() }}</span>
          </div>
        }

        <div class="form-control mt-4">
          <label class="label">
            <span class="label-text">Nombre</span>
          </label>
          <input
            type="text"
            placeholder="Nombre de la categoría"
            class="input input-bordered w-full"
            [formControl]="nameControl"
            [class.input-error]="nameControl.invalid && nameControl.touched"
          />
          @if (nameControl.invalid && nameControl.touched) {
            <label class="label">
              <span class="label-text-alt text-error">El nombre es obligatorio</span>
            </label>
          }
        </div>

        <div class="form-control mt-4 flex flex-col">
          <label class="label">
            <span class="label-text">Descripción</span>
          </label>
          <textarea
            class="textarea textarea-bordered min-h-[60px] w-full"
            placeholder="Descripción de la categoría..."
            [formControl]="descriptionControl"
            [class.textarea-error]="descriptionControl.invalid && descriptionControl.touched"
          ></textarea>
          @if (descriptionControl.invalid && descriptionControl.touched) {
            <label class="label">
              <span class="label-text-alt text-error">La descripción es obligatoria</span>
            </label>
          }
        </div>

        <div class="modal-action">
          <button class="btn" (click)="closeModals()" [disabled]="isSubmitting()">Cancelar</button>
          <button class="btn btn-primary" (click)="saveCategory()" [disabled]="isSubmitting()">
            @if (isSubmitting()) {
              <span class="loading loading-spinner loading-xs mr-2"></span>
            }
            Guardar cambios
          </button>
        </div>
      </div>
      <div class="modal-backdrop" (click)="closeModals()"></div>
    </div>
  }

  @if (showDeleteModal()) {
    <div class="modal modal-open">
      <div class="modal-box">
        <h3 class="font-bold text-lg">¿Estás seguro?</h3>
        <p class="py-4">
          Esta acción no se puede deshacer. Esto eliminará permanentemente la
          categoría "{{ categoryToDelete()?.name }}" y podría afectar a los
          productos asociados.
        </p>

        @if (errorMessage()) {
          <div class="alert alert-error my-2">
            <lucide-angular name="alert-circle" class="w-5 h-5 mr-2"></lucide-angular>
            <span>{{ errorMessage() }}</span>
          </div>
        }

        <div class="modal-action">
          <button class="btn" (click)="closeModals()" [disabled]="isSubmitting()">Cancelar</button>
          <button class="btn btn-error" (click)="deleteCategory()" [disabled]="isSubmitting()">
            @if (isSubmitting()) {
              <span class="loading loading-spinner loading-xs mr-2"></span>
            } @else {
              <lucide-angular name="trash-2" class="w-5 h-5 mr-2"></lucide-angular>
            }
            Eliminar
          </button>
        </div>
      </div>
      <div class="modal-backdrop" (click)="closeModals()"></div>
    </div>
  }
</div>
