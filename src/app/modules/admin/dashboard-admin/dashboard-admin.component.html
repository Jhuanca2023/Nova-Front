<div class="container mx-auto p-6">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold">Dashboard</h1>
      <p class="text-muted-foreground">Panel de control y estadísticas</p>
    </div>
    <div class="flex flex-col md:flex-row items-end md:items-center gap-3">
      <!-- Botón de recarga de gráficas -->
      <button
        class="btn btn-outline btn-sm"
        (click)="reloadCharts()"
        [disabled]="reloadingCharts()"
        [class.loading]="reloadingCharts()"
        title="Recargar gráficas">
        @if (!reloadingCharts()) {
          <lucide-angular name="refresh-cw" class="w-4 h-4 mr-2"></lucide-angular>
          Recargar gráficas
        } @else {
          Recargando...
        }
      </button>
      <div class="text-sm text-muted-foreground">
        Última actualización: {{ currentDate() | date : "dd/MM/yyyy" }}
        {{ currentDate() | date : "HH:mm" }}
      </div>
    </div>
  </div>

  @if (isLoading()) {
    <div class="flex justify-center items-center py-16">
      <div class="flex flex-col items-center">
        <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
        <span class="text-base-content/70">Cargando datos del dashboard...</span>
      </div>
    </div>
  } @else if (error()) {
    <div class="alert alert-error mb-6">
      <lucide-angular name="alert-triangle" class="w-5 h-5"></lucide-angular>
      <span>{{ error() }}</span>
      <button class="btn btn-sm" (click)="loadDashboardData()">Reintentar</button>
    </div>
  } @else {
    <!-- Tarjetas de estadísticas -->
    <div class="grid gap-6 mb-8 md:grid-cols-2 lg:grid-cols-4">
      @for (card of statsCards(); track card.title) {
        <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow">
          <div class="card-body p-6 flex flex-row items-center">
            <div class="p-2 mr-4 rounded-full" [ngClass]="card.iconBgColor">
              <lucide-angular
                name="{{ card.icon }}"
                class="w-8 h-8"
                [ngClass]="card.iconColor"
              ></lucide-angular>
            </div>
            <div>
              <p class="text-sm opacity-70">{{ card.title }}</p>
              <div class="flex items-center">
                <h4 class="text-2xl font-bold">{{ card.value }}</h4>
                <span
                  class="flex items-center ml-2 text-sm font-medium"
                  [ngClass]="
                    card.percentChange >= 0 ? 'text-success' : 'text-error'
                  "
                >
                  @if (card.percentChange >= 0) {
                    <lucide-angular
                      name="arrow-up"
                      class="w-4 h-4 mr-1"
                    ></lucide-angular>
                  } @else {
                    <lucide-angular
                      name="arrow-down"
                      class="w-4 h-4 mr-1"
                    ></lucide-angular>
                  }
                  {{ Math.abs(card.percentChange) }}%
                </span>
              </div>
              <p class="text-xs opacity-70">{{ card.description }}</p>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Productos con bajo stock y Categorías principales -->
    <div class="grid gap-6 mb-8 md:grid-cols-2">
      <!-- Productos con bajo stock -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h3 class="card-title flex items-center">
              <lucide-angular name="alert-triangle" class="w-5 h-5 mr-2 text-warning"></lucide-angular>
              Productos con bajo stock
            </h3>
            <!-- Botón de recarga individual para esta gráfica -->
            <button
              class="btn btn-ghost btn-xs"
              (click)="reloadCharts()"
              [disabled]="reloadingCharts()"
              title="Recargar gráfica">
              <lucide-angular name="refresh-cw" class="w-4 h-4"></lucide-angular>
            </button>
          </div>

          <div class="h-64 relative">
            @if (reloadingCharts()) {
              <div class="absolute inset-0 flex items-center justify-center bg-base-100/50 z-10">
                <span class="loading loading-spinner loading-md"></span>
              </div>
            }
            <canvas id="stockChart"></canvas>
          </div>

          <div class="overflow-x-auto mt-4">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="text-right">Stock</th>
                  <th class="text-right">Estado</th>
                </tr>
              </thead>
              <tbody>
                @for (product of lowStockProducts(); track product.id) {
                  <tr>
                    <td class="max-w-[250px] truncate">{{ product.name }}</td>
                    <td class="text-right">{{ product.stock }}</td>
                    <td class="text-right">
                      <span [ngClass]="getStockStatusClass(product.stock)">
                        {{ getStockStatusText(product.stock) }}
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Categorías principales -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h3 class="card-title flex items-center">
              <lucide-angular name="tag" class="w-5 h-5 mr-2 text-primary"></lucide-angular>
              Distribución de productos por categoría
            </h3>
            <!-- Botón de recarga individual para esta gráfica -->
            <button
              class="btn btn-ghost btn-xs"
              (click)="reloadCharts()"
              [disabled]="reloadingCharts()"
              title="Recargar gráfica">
              <lucide-angular name="refresh-cw" class="w-4 h-4"></lucide-angular>
            </button>
          </div>

          <div class="h-64 relative">
            @if (reloadingCharts()) {
              <div class="absolute inset-0 flex items-center justify-center bg-base-100/50 z-10">
                <span class="loading loading-spinner loading-md"></span>
              </div>
            }
            <canvas id="categoryChart"></canvas>
          </div>

          <div class="overflow-x-auto mt-4">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th class="text-right">Productos</th>
                  <th class="text-right">% del total</th>
                </tr>
              </thead>
              <tbody>
                @for (category of topCategories(); track category.id) {
                  <tr>
                    <td>{{ category.name }}</td>
                    <td class="text-right">{{ category.productCount }}</td>
                    <td class="text-right">
                      {{ Math.round((category.productCount / dashboardData()!.productStats.totalProductsCount) * 100) }}%
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Información adicional -->
    <div class="grid gap-6">
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h3 class="card-title flex items-center">
            <lucide-angular name="info" class="w-5 h-5 mr-2 text-primary"></lucide-angular>
            Resumen del sistema
          </h3>

          <div class="divider"></div>

          <div class="grid gap-6 md:grid-cols-3">
            <div>
              <h4 class="font-medium text-base mb-2">Usuarios</h4>
              <div class="stats shadow">
                <div class="stat">
                  <div class="stat-title">Total</div>
                  <div class="stat-value">{{ dashboardData()?.userStats!.totalUsersCount }}</div>
                  <div class="stat-desc">
                    {{ dashboardData()?.userStats!.activeUsersCount }} activos ({{ Math.round((dashboardData()!.userStats.activeUsersCount / dashboardData()!.userStats.totalUsersCount) * 100) }}%)
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h4 class="font-medium text-base mb-2">Productos</h4>
              <div class="stats shadow">
                <div class="stat">
                  <div class="stat-title">Inventario</div>
                  <div class="stat-value">{{ dashboardData()?.productStats!.totalProductsCount }}</div>
                  <div class="stat-desc text-warning">
                    {{ dashboardData()?.productStats!.lowStockProductsCount }} con stock bajo
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h4 class="font-medium text-base mb-2">Categorías</h4>
              <div class="stats shadow">
                <div class="stat">
                  <div class="stat-title">Total</div>
                  <div class="stat-value">{{ dashboardData()?.categoryStats!.totalCategoriesCount }}</div>
                  <div class="stat-desc">
                    {{ dashboardData()?.categoryStats!.activeCategoriesCount }} categorías activas
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>
