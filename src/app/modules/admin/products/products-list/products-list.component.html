<div class="container mx-auto p-6">
  <!-- Header -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"
  >
  <div class="flex gap-2">
    <button
      class="btn btn-outline mt-4 md:mt-0"
      (click)="downloadProductReport()"
      [disabled]="isGeneratingReport()"
    >
      @if (isGeneratingReport()) {
        <span class="loading loading-spinner loading-xs"></span>
      } @else {
        <lucide-angular name="file-text" class="w-5 h-5 mr-2"></lucide-angular>
      }
      Descargar Reporte
    </button>
    <a routerLink="create" class="btn btn-primary mt-4 md:mt-0">
      <lucide-angular name="plus" class="w-5 h-5 mr-2"></lucide-angular>
      Nuevo producto
    </a>
  </div>
  </div>

  <div class="card bg-base-100 mb-6 shadow">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title">
          <lucide-angular name="filter" class="w-5 h-5 mr-2"></lucide-angular>
          Filtros
        </h2>
        <button
          class="btn btn-sm btn-outline"
          (click)="resetFilters()"
          [disabled]="
            !searchControl.value &&
            !categoryControl.value &&
            !statusControl.value
          "
        >
          <lucide-angular name="x" class="w-4 h-4 mr-1"></lucide-angular>
          Limpiar filtros
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Search -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Buscar</span>
          </label>
          <div class="input-group">
            <input
              type="text"
              placeholder="Buscar producto..."
              class="input input-bordered w-full"
              [formControl]="searchControl"
            />
            <!-- <button class="btn btn-square" (click)="loadProducts()">
              <lucide-angular name="search" class="w-5 h-5"></lucide-angular>
            </button> -->
          </div>
        </div>

        <!-- Category Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Categoría</span>
          </label>
          <select
            class="select select-bordered w-full"
            [formControl]="categoryControl"
          >
            <option [value]="null">Todas las categorías</option>
            @for (category of categories(); track category.id) {
            <option [value]="category.id">
              {{ category.name }}
            </option>
            }
          </select>
        </div>

        <!-- Status Filter -->
        <!-- Status Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Estado</span>
          </label>
          <select
            class="select select-bordered w-full"
            [formControl]="statusControl"
          >
            <option [value]="null">Todos los estados</option>
            <option value="Active">Activo</option>
            <option value="Inactive">Inactivo</option>
            <option value="OutOfStock">Sin Stock</option>
          </select>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mt-4">
        @if (searchControl.value) {
        <div class="badge badge-primary gap-1">
          Búsqueda: {{ searchControl.value }}
          <button
            (click)="searchControl.setValue(''); loadProducts()"
            class="btn btn-xs btn-circle btn-ghost"
          >
            <lucide-angular name="x" class="w-3 h-3"></lucide-angular>
          </button>
        </div>
        } @if (categoryControl.value) {
        <div class="badge badge-primary gap-1">
          Categoría: {{ getCategoryName(categoryControl.value) }}
          <button
            (click)="categoryControl.setValue(null); loadProducts()"
            class="btn btn-xs btn-circle btn-ghost"
          >
            <lucide-angular name="x" class="w-3 h-3"></lucide-angular>
          </button>
        </div>
        } @if (statusControl.value) {
        <div class="badge badge-primary gap-1">
          Estado: {{ getStatusLabel(statusControl.value) }}
          <button
            (click)="statusControl.setValue(null); loadProducts()"
            class="btn btn-xs btn-circle btn-ghost"
          >
            <lucide-angular name="x" class="w-3 h-3"></lucide-angular>
          </button>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="w-full flex justify-center my-12">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="alert alert-error mb-6">
    <lucide-angular name="alert-triangle" class="w-5 h-5"></lucide-angular>
    <span>{{ error() }}</span>
    <button class="btn btn-sm" (click)="loadProducts()">Reintentar</button>
  </div>
  }

  <!-- Products Table -->
  @if (!isLoading() && !error() && sortedProducts().length > 0) {
  <div class="card bg-base-100 shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <!-- Table Head -->
        <thead>
          <tr>
            <th class="w-16">ID</th>
            <th class="w-20">Imagen</th>
            <th class="cursor-pointer" (click)="sortBy('name')">
              <div class="flex items-center">
                Nombre @if (sortColumn() === 'name') {
                <lucide-angular
                  [name]="
                    sortDirection() === 'asc' ? 'chevron-up' : 'chevron-down'
                  "
                  class="w-4 h-4 ml-1"
                ></lucide-angular>
                }
              </div>
            </th>
            <th class="cursor-pointer" (click)="sortBy('price')">
              <div class="flex items-center">
                Precio @if (sortColumn() === 'price') {
                <lucide-angular
                  [name]="
                    sortDirection() === 'asc' ? 'chevron-up' : 'chevron-down'
                  "
                  class="w-4 h-4 ml-1"
                ></lucide-angular>
                }
              </div>
            </th>
            <th>Categoría</th>
            <th>Estado</th>
            <th class="w-32">Acciones</th>
          </tr>
        </thead>
        <!-- Table Body -->
        <tbody>
          @for (product of sortedProducts(); track product.id) {
          <tr>
            <td>{{ product.id }}</td>
            <td>
              <div class="avatar">
                <div class="w-12 h-12 mask mask-squircle">
                  <img
                    [src]="product.imageUrl || '/assets/images/placeholder.png'"
                    [alt]="product.name"
                  />
                </div>
              </div>
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.price | currencyPEN }}</td>
            <td>{{ product.categoryName }}</td>
            <td>
              <div class="badge min-w-[80px] justify-center" [ngClass]="getStatusBadgeClass(product)">
                {{ getProductStatus(product) }}
              </div>
            </td>
            <td>
              <div class="flex space-x-2">
                <button
                  class="btn btn-square btn-sm btn-ghost"
                  [routerLink]="['edit', product.id]"
                >
                  <lucide-angular name="edit" class="w-4 h-4"></lucide-angular>
                </button>
                <button
                  class="btn btn-square btn-sm btn-ghost text-error"
                  (click)="confirmDelete(product)"
                >
                  <lucide-angular name="trash" class="w-4 h-4"></lucide-angular>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="flex justify-between items-center mt-6">
    <div class="text-sm text-muted-foreground">
      Mostrando {{ startIndex() }} - {{ endIndex() }} de
      {{ totalItems() }} productos
    </div>
    <div class="join">
      <button
        class="join-item btn"
        [disabled]="currentPage() === 1"
        (click)="goToPage(currentPage() - 1)"
      >
        <lucide-angular name="chevron-left" class="w-5 h-5"></lucide-angular>
      </button>
      @for (page of pagesArray(); track page) {
      <button
        class="join-item btn"
        [class.btn-active]="currentPage() === page"
        (click)="goToPage(page)"
      >
        {{ page }}
      </button>
      }
      <button
        class="join-item btn"
        [disabled]="currentPage() === totalPages()"
        (click)="goToPage(currentPage() + 1)"
      >
        <lucide-angular name="chevron-right" class="w-5 h-5"></lucide-angular>
      </button>
    </div>
  </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && !error() && sortedProducts().length === 0) {
  <div
    class="card bg-base-100 p-12 shadow flex flex-col items-center justify-center text-center"
  >
    <lucide-angular
      name="package"
      class="w-16 h-16 text-muted-foreground mb-4"
    ></lucide-angular>
    <h3 class="text-xl font-bold mb-2">No se encontraron productos</h3>
    <p class="text-muted-foreground mb-6">
      No hay productos que coincidan con tus criterios de búsqueda.
    </p>
    <button class="btn btn-primary" (click)="resetFilters()">
      <lucide-angular name="refresh-cw" class="w-5 h-5 mr-2"></lucide-angular>
      Restablecer filtros
    </button>
  </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal()) {
  <div class="modal modal-open">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Confirmar eliminación</h3>
      <p class="py-4">
        ¿Estás seguro de que deseas eliminar el producto "{{
          productToDelete()?.name
        }}"? Esta acción no se puede deshacer.
      </p>
      <div class="modal-action">
        <button class="btn" (click)="showDeleteModal.set(false)">
          Cancelar
        </button>
        <button class="btn btn-error" (click)="deleteProduct()">
          <lucide-angular name="trash" class="w-5 h-5 mr-2"></lucide-angular>
          Eliminar
        </button>
      </div>
    </div>
  </div>
  }
</div>
