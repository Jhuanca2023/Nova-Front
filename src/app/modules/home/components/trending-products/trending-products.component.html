<section class="py-12">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <lucide-angular
          name="trending-up"
          class="w-6 h-6 mr-2 text-primary"
        ></lucide-angular>
        <div>
          <h2 class="text-3xl font-bold tracking-tight">
            Productos en tendencia
          </h2>
          <p class="mt-2 text-muted-foreground">
            Los productos más populares del momento
          </p>
        </div>
      </div>
      <a routerLink="/products" class="btn btn-outline"> Ver Más </a>
    </div>

    @if (productsResource.isLoading()) {
      <div class="flex justify-center py-12">
        <div class="loading loading-spinner loading-lg text-primary"></div>
      </div>
    } @else if (enhancedProducts().length === 0) {
      <div class="text-center py-12">
        <p class="text-muted-foreground">
          No hay productos en tendencia disponibles en este momento.
        </p>
      </div>
    } @else {
      <div #carouselContainer class="relative mb-16">
        <div class="overflow-hidden mx-auto max-w-7xl">
          <div class="carousel-container">
            <div
              class="carousel-group"
              [style.transform]="'translateX(-' + currentSlide() * 100 + '%)'"
            >
              @for (slideIndex of slideIndicators; track slideIndex) {
                <div class="product-slide">
                  @for (product of getSlideProducts(slideIndex); track product.id) {
                    <div class="product-item visible" [style.--index]="$index">
                      <div class="relative">
                        @if (product.etiqueta) {
                          <div class="badge badge-primary absolute top-2 left-2 z-10">
                            {{ product.etiqueta }}
                          </div>
                        }
                        @if (product.precioAnterior) {
                          <div class="badge badge-secondary absolute top-2 right-2 z-10">
                            -{{ calcularDescuento(product.price, product.precioAnterior) }}%
                          </div>
                        }
                        <product-card [product]="product"></product-card>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <button
          (click)="prevSlide()"
          class="btn btn-circle btn-primary fixed-nav-btn left-0 md:-left-4"
          [disabled]="currentSlide() === 0"
          [class.opacity-50]="currentSlide() === 0"
          aria-label="Anterior"
        >
          <lucide-angular
            name="chevron-left"
            class="w-6 h-6"
          ></lucide-angular>
        </button>

        <button
          (click)="nextSlide()"
          class="btn btn-circle btn-primary fixed-nav-btn right-0 md:-right-4"
          [disabled]="currentSlide() === totalSlides - 1"
          [class.opacity-50]="currentSlide() === totalSlides - 1"
          aria-label="Siguiente"
        >
          <lucide-angular
            name="chevron-right"
            class="w-6 h-6"
          ></lucide-angular>
        </button>

        <div
          class="flex justify-center mt-8 space-x-2 absolute bottom-[-40px] left-0 right-0"
        >
          @for (indicator of slideIndicators; track indicator) {
            <button
              (click)="goToSlide(indicator)"
              class="w-3 h-3 rounded-full transition-colors duration-200 cursor-pointer"
              [class.bg-primary]="currentSlide() === indicator"
              [class.bg-gray-300]="currentSlide() !== indicator"
              [attr.aria-label]="'Ir a slide ' + (indicator + 1)"
            ></button>
          }
        </div>
      </div>
    }
  </div>
</section>

<style>
  .carousel-container {
    overflow: hidden;
  }

  .carousel-group {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }

  .product-slide {
    min-width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .product-item {
    opacity: 0;
    transform: translateY(20px);
  }

  .product-item.visible {
    opacity: 1;
    transform: translateY(0);
    transition: all 0.5s cubic-bezier(0.33, 1, 0.68, 1);
    transition-delay: calc(var(--index, 0) * 100ms);
  }

  .fixed-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
  }

  .badge {
    z-index: 5;
  }
</style>
